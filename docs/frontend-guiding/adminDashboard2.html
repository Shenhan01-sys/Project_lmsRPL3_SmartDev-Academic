<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Real-Time Dashboard - SmartDev LMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        accent: '#4f46e5',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        sidebar: '#1e293b',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: #94a3b8; transition: all 0.2s; border-right: 3px solid transparent; cursor: pointer; border-radius: 0.5rem; margin-bottom: 0.25rem; }
        .nav-link:hover { background: rgba(255, 255, 255, 0.05); color: #fff; }
        .nav-link.active { background: linear-gradient(90deg, rgba(79, 70, 229, 0.2) 0%, transparent 100%); color: #fff; border-right-color: #4f46e5; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>

<body class="flex h-screen overflow-hidden text-slate-800">

    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mb-3"></div>
            <span class="text-slate-600 font-bold text-sm tracking-wider">MENGAMBIL DATA...</span>
        </div>
    </div>

    <aside class="w-64 bg-sidebar text-white hidden md:flex flex-col shadow-2xl z-20 shrink-0 transition-all duration-300">
        <div class="p-6 border-b border-white/10 flex items-center gap-3">
            <div class="w-8 h-8 bg-accent rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <i class="bi bi-shield-lock-fill text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">SmartDev</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Admin Panel</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <div class="px-3 mb-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Menu Utama</div>
            <div onclick="navTo('dashboard')" id="nav-dashboard" class="nav-link active">
                <i class="bi bi-grid-1x2 me-3 text-lg"></i> <span class="font-medium">Dashboard</span>
            </div>
            <div onclick="navTo('registrations')" id="nav-registrations" class="nav-link relative">
                <i class="bi bi-person-plus me-3 text-lg"></i> <span class="font-medium">Registrasi Siswa</span>
                <span id="badge-pending" class="absolute right-3 bg-danger text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden shadow-sm">0</span>
            </div>

            <div class="px-3 mb-2 mt-6 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Manajemen</div>
            <div onclick="navTo('instructors')" id="nav-instructors" class="nav-link">
                <i class="bi bi-person-video3 me-3 text-lg"></i> <span class="font-medium">Instruktur</span>
            </div>
            <div onclick="navTo('students')" id="nav-students" class="nav-link">
                <i class="bi bi-people me-3 text-lg"></i> <span class="font-medium">Siswa & User</span>
            </div>
            <div onclick="navTo('courses')" id="nav-courses" class="nav-link">
                <i class="bi bi-journal-bookmark-fill me-3 text-lg"></i> <span class="font-medium">Kursus</span>
            </div>

            <div class="px-3 mb-2 mt-6 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Lainnya</div>
            <div onclick="navTo('announcements')" id="nav-announcements" class="nav-link">
                <i class="bi bi-megaphone me-3 text-lg"></i> <span class="font-medium">Pengumuman</span>
            </div>
        </nav>

        <div class="p-4 border-t border-white/10 bg-slate-900/50">
            <button onclick="logout()" class="w-full py-2.5 bg-white/5 hover:bg-red-500/20 text-slate-300 hover:text-red-400 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 group">
                <i class="bi bi-box-arrow-right group-hover:scale-110 transition-transform"></i> KELUAR SISTEM
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-50">
        <div class="md:hidden bg-sidebar text-white p-4 flex justify-between items-center shadow-md z-30 shrink-0">
            <span class="font-bold flex items-center gap-2"><i class="bi bi-shield-lock-fill text-accent"></i> Admin Panel</span>
            <button onclick="alert('Menu mobile belum aktif')" class="text-xl"><i class="bi bi-list"></i></button>
        </div>

        <div id="main-scroll" class="flex-1 overflow-y-auto p-6 lg:p-8 scroll-smooth">

            <section id="view-dashboard" class="page-view fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 tracking-tight">Dashboard Eksekutif</h2>
                        <p class="text-slate-500 mt-1 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            Sistem Terhubung & Online
                        </p>
                    </div>
                    <button onclick="loadDashboardData()" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-accent hover:border-accent shadow-sm transition-all text-sm font-medium flex items-center gap-2">
                        <i class="bi bi-arrow-clockwise"></i> Segarkan Data
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total User</p>
                            <h3 class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-users">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-blue-50 to-transparent group-hover:from-blue-100 transition-all"></div>
                        <i class="bi bi-people-fill absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-blue-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group cursor-pointer" onclick="navTo('registrations')">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Registrasi Pending</p>
                            <h3 class="text-3xl font-extrabold text-orange-500 mt-2" id="stat-pending">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-orange-50 to-transparent group-hover:from-orange-100 transition-all"></div>
                        <i class="bi bi-person-plus-fill absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-orange-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Kursus Aktif</p>
                            <h3 class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-courses">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-emerald-50 to-transparent group-hover:from-emerald-100 transition-all"></div>
                        <i class="bi bi-book-half absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-emerald-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Instruktur</p>
                            <h3 class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-instructors">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-indigo-50 to-transparent group-hover:from-indigo-100 transition-all"></div>
                        <i class="bi bi-person-video3 absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-indigo-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">Tren Pendaftaran User</h4>
                                <p class="text-xs text-slate-500">Berdasarkan data real-time tahun ini</p>
                            </div>
                            <div class="p-2 bg-blue-50 rounded-lg text-accent"><i class="bi bi-graph-up"></i></div>
                        </div>
                        <div class="h-72 w-full"><canvas id="registrationChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="font-bold text-slate-800 text-lg">Distribusi Role</h4>
                            <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i class="bi bi-pie-chart-fill"></i></div>
                        </div>
                        <div class="h-64 flex justify-center items-center relative flex-1">
                            <canvas id="userDistChart"></canvas>
                        </div>
                        <div class="mt-4 text-center text-xs text-slate-400">Total data dari database</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    <i class="bi bi-exclamation-triangle-fill text-red-500"></i> Early Warning
                                </h4>
                                <p class="text-xs text-slate-500">Siswa berisiko (Nilai Rendah)</p>
                            </div>
                            <span class="px-2 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-full animate-pulse">Live Data</span>
                        </div>

                        <div class="flex-1 overflow-y-auto pr-2 space-y-3 max-h-80 custom-scrollbar" id="ews-list">
                            <div class="text-center py-8 text-slate-400 text-sm">Menghitung risiko akademik...</div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">Analisis Akademik</h4>
                                <p class="text-xs text-slate-500">Distribusi Siswa berdasarkan Nilai Akhir (Y)</p>
                            </div>
                            <div class="flex gap-2">
                                <span class="flex items-center gap-1 text-[10px] text-slate-500"><span class="w-2 h-2 rounded-full bg-emerald-400"></span> Aman (>60)</span>
                                <span class="flex items-center gap-1 text-[10px] text-slate-500"><span class="w-2 h-2 rounded-full bg-red-400"></span> Berisiko (<60)</span>
                            </div>
                        </div>
                        <div class="h-80 w-full relative">
                            <canvas id="academicScatterChart"></canvas>
                        </div>
                    </div>
                </div>

            </section>

            <section id="view-registrations" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Registrasi Siswa</h2>
                        <p class="text-slate-500 text-sm mt-1">Validasi calon siswa yang mendaftar.</p>
                    </div>
                    <button onclick="loadRegistrations()" class="p-2 bg-white border rounded-lg text-slate-600 hover:text-accent"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-4 font-semibold">Calon Siswa</th>
                                    <th class="px-6 py-4 font-semibold">Kontak</th>
                                    <th class="px-6 py-4 font-semibold">Dokumen</th>
                                    <th class="px-6 py-4 font-semibold">Tgl Daftar</th>
                                    <th class="px-6 py-4 text-center font-semibold">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="registration-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-instructors" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Daftar Instruktur</h2>
                    <button onclick="openModal('modal-instructor')" class="bg-accent hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/30 flex items-center gap-2 transition-all">
                        <i class="bi bi-plus-lg"></i> Tambah Instruktur
                    </button>
                </div>
                <div id="instructors-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </section>

            <section id="view-students" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Database Siswa</h2>
                    </div>
                    <div class="relative flex gap-2">
                        <select id="filter-student-status" onchange="loadStudents()" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Semua Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" id="search-student" onkeyup="debounceSearchStudent()" placeholder="Cari siswa..." class="pl-4 pr-10 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent w-64">
                        <i class="bi bi-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="bg-slate-50 border-b text-xs uppercase text-slate-500 font-bold">
                            <tr>
                                <th class="px-6 py-4">Nama Lengkap</th>
                                <th class="px-6 py-4">Email</th>
                                <th class="px-6 py-4">NIS/NIM</th>
                                <th class="px-6 py-4">Orang Tua</th>
                                <th class="px-6 py-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="5" class="p-8 text-center text-slate-400">Memuat data siswa...</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 text-xs text-slate-500 flex justify-between items-center">
                        <span id="student-count-info">0 Data</span>
                        <div class="flex gap-1">
                            <button onclick="changeStudentPage(-1)" class="px-3 py-1 border rounded hover:bg-white disabled:opacity-50" id="btn-prev-student">Prev</button>
                            <button onclick="changeStudentPage(1)" class="px-3 py-1 border rounded hover:bg-white disabled:opacity-50" id="btn-next-student">Next</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-courses" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Manajemen Kursus</h2>
                    <button onclick="openCreateCourseModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                        <i class="bi bi-plus-lg"></i> Buat Kursus
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-8">
                    <h4 class="font-bold text-slate-700 mb-4">Top 5 Kursus Terpopuler</h4>
                    <div class="h-64 w-full"><canvas id="popularCoursesChart"></canvas></div>
                </div>
                <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="view-announcements" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Pengumuman Global</h2>
                    <button onclick="openModal('modal-announcement')" class="bg-slate-800 hover:bg-slate-900 text-white px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="bi bi-megaphone-fill"></i> Buat Baru
                    </button>
                </div>
                <div id="announcements-list" class="space-y-4"></div>
            </section>

        </div>
    </main>

    <div id="modal-instructor" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Tambah Instruktur</h3>
            <form onsubmit="event.preventDefault(); submitInstructor();">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <input type="text" id="ins-code" placeholder="Kode (e.g. INS001)" class="border rounded p-2 text-sm" required>
                    <input type="text" id="ins-name" placeholder="Nama Lengkap" class="border rounded p-2 text-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <input type="email" id="ins-email" placeholder="Email" class="border rounded p-2 text-sm" required>
                    <input type="text" id="ins-phone" placeholder="No. Telepon" class="border rounded p-2 text-sm">
                </div>
                <input type="password" id="ins-pass" placeholder="Password" class="border rounded p-2 text-sm w-full mb-3" required>
                <input type="text" id="ins-spec" placeholder="Spesialisasi" class="border rounded p-2 text-sm w-full mb-3">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('modal-instructor')" class="px-4 py-2 text-slate-500 text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-accent text-white rounded text-sm font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-create-course" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Buat Kursus Baru</h3>
            <form onsubmit="event.preventDefault(); submitCreateCourse();">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <input type="text" id="course-code" placeholder="Kode Kursus" class="border rounded p-2 text-sm" required>
                    <input type="text" id="course-name" placeholder="Nama Kursus" class="border rounded p-2 text-sm" required>
                </div>
                <div class="mb-3">
                    <label class="text-xs font-bold text-slate-500 uppercase">Instruktur</label>
                    <select id="course-instructor" class="w-full border rounded p-2 text-sm bg-white" required></select>
                </div>
                <textarea id="course-desc" placeholder="Deskripsi" class="border rounded p-2 text-sm w-full mb-3" rows="3"></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('modal-create-course')" class="px-4 py-2 text-slate-500 text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded text-sm font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-announcement" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Buat Pengumuman Global</h3>
            <form onsubmit="event.preventDefault(); submitAnnouncement();">
                <input type="text" id="ann-title" placeholder="Judul" class="w-full border rounded p-2 text-sm mb-3" required>
                <textarea id="ann-content" placeholder="Isi Pengumuman" class="w-full border rounded p-2 text-sm mb-3" rows="4" required></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('modal-announcement')" class="px-4 py-2 text-slate-500 text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-accent text-white rounded text-sm font-bold">Kirim</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'https://portohansgunawan.my.id/api/v1';
        let authToken = localStorage.getItem('auth_token');
        let studentPage = 1;
        let studentSearchDebounce;

        let store = {
            users: [],
            courses: [],
            instructors: [],
            registrations: [],
            announcements: [],
            stats: {}
        };

        // --- AUTH & FETCH HELPER ---
        function getHeaders(isFormData = false) {
            const headers = {
                'Accept': 'application/json',
                'Authorization': `Bearer ${authToken}`,
                'ngrok-skip-browser-warning': 'true'
            };
            if (!isFormData) headers['Content-Type'] = 'application/json';
            return headers;
        }

        async function fetchApi(endpoint, options = {}) {
            // Show loader for non-GET requests or if explicitly asked
            if (options.method && options.method !== 'GET') document.getElementById('loader').style.display = 'flex';

            try {
                const isFormData = options.body instanceof FormData;
                const url = endpoint.startsWith('http') ? endpoint : (API_BASE + endpoint);
                
                const res = await fetch(url, {
                    ...options,
                    headers: { ...getHeaders(isFormData), ...options.headers }
                });

                if (res.status === 401) {
                    localStorage.removeItem('auth_token');
                    location.reload();
                    return null;
                }

                if (res.status === 204) return true; // No content

                const json = await res.json().catch(() => null);
                
                if (!res.ok) throw new Error(json?.message || `HTTP ${res.status}`);
                
                return json;
            } catch (e) {
                console.error("API Error:", e);
                Swal.fire("Error", e.message, "error");
                return null;
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // --- INIT & AUTH ---
        async function initAuth() {
            if (!authToken) {
                const { value: token } = await Swal.fire({
                    title: 'Admin Login',
                    input: 'text',
                    inputLabel: 'Masukkan Token API',
                    confirmButtonText: 'Masuk',
                    allowOutsideClick: false,
                    inputValidator: (value) => { if (!value) return 'Token wajib diisi!' }
                });
                if (token) {
                    localStorage.setItem('auth_token', token);
                    authToken = token;
                    initAuth(); // Retry init
                }
                return;
            }
            
            // Verify token by fetching user
            const user = await fetchApi(API_BASE.replace('/v1', '/user'), { method: 'GET' });
            if (user) {
                loadDashboardData();
            }
        }

        async function initApp() {
             // Helper untuk reconnect button di header
             // Perbarui BASE_URL jika input diganti
             if(document.getElementById('ngrokUrl').value) {
                // logic update base url here if needed, but const is const.
                // reload page is better.
                location.reload();
             }
        }

        // --- DASHBOARD LOGIC ---
        async function loadDashboardData() {
            document.getElementById('loader').style.display = 'flex';
            
            try {
                // 1. Load Summary & Charts Data from Backend
                const [summary, statsReg, statsUser, statsAcademic, ewsData] = await Promise.all([
                    fetchApi('/stats/summary'),
                    fetchApi('/stats/registrations'),
                    fetchApi('/stats/users'),
                    fetchApi('/stats/academic'),
                    fetchApi('/stats/risk-analysis')
                ]);

                // 2. Render Summary Cards
                if (summary) {
                    document.getElementById('stat-users').innerText = summary.total_users || 0;
                    document.getElementById('stat-courses').innerText = summary.active_courses || 0;
                    document.getElementById('stat-pending').innerText = summary.pending_registrations || 0;
                    document.getElementById('stat-instructors').innerText = summary.total_instructors || 0;
                    
                    const badge = document.getElementById('badge-pending');
                    if(summary.pending_registrations > 0) {
                        badge.innerText = summary.pending_registrations;
                        badge.classList.remove('hidden');
                    }
                }

                // 3. Render Charts
                if (statsReg) renderRegistrationChart(statsReg);
                if (statsUser) renderUserDistChart(statsUser);
                if (statsAcademic) renderAcademicChart(statsAcademic);
                if (ewsData) renderEWS(ewsData);
                
                // 4. Load Scatter Plot (Simplified/Safe version)
                loadSafeScatterPlot();

            } catch (e) {
                console.error("Dashboard Load Error", e);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // --- CHARTS & VISUALIZATION ---
        function renderRegistrationChart(data) {
            const ctx = document.getElementById('registrationChart');
            if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Pendaftar',
                        data: data.data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderUserDistChart(data) {
            const ctx = document.getElementById('userDistChart');
            if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Siswa', 'Instruktur', 'Admin', 'Ortu'],
                    datasets: [{
                        data: [data.student, data.instructor, data.admin, data.parent],
                        backgroundColor: ['#4f46e5', '#f59e0b', '#0f172a', '#10b981']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderAcademicChart(data) {
            const ctx = document.getElementById('academicChart');
            if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.course_name),
                    datasets: [{
                        label: 'Rata-rata Nilai',
                        data: data.map(d => d.average_score),
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function renderEWS(data) {
            const list = document.getElementById('ews-list');
            
            if (!data || data.length === 0) {
                list.innerHTML = '<div class="text-center text-emerald-500 text-xs py-4"><i class="bi bi-check-circle"></i> Aman. Tidak ada siswa berisiko.</div>';
                return;
            }

            list.innerHTML = data.map(s => `
                <div class="flex items-start gap-3 p-3 bg-red-50 rounded-lg border border-red-100">
                    <div class="w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center text-xs font-bold">${s.name.charAt(0)}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between">
                            <h5 class="font-bold text-slate-800 text-xs truncate">${s.name}</h5>
                            <span class="text-[10px] font-bold text-red-600 bg-white border border-red-200 px-1.5 rounded">Nilai: ${s.grade}</span>
                        </div>
                        <p class="text-[10px] text-slate-500 truncate">${s.course}</p>
                        <div class="text-[10px] text-red-400 mt-1"><i class="bi bi-telephone"></i> ${s.parent_phone}</div>
                    </div>
                </div>
            `).join('');
        }

        // Safe Scatter Plot (No massive API calls)
        async function loadSafeScatterPlot() {
            // Untuk menghindari crash browser/CORS error karena request 400+,
            // Kita hanya akan menampilkan data dari endpoint 'risk-analysis' (yang sudah punya data nilai & kehadiran)
            // Atau jika ingin lebih, bisa gunakan data enrollments tapi tanpa attendance % (x=0)
            
            const ctx = document.getElementById('academicScatterChart');
            if (!ctx) return;

            // Gunakan data EWS yang sudah diload (sebagai sampel data berisiko)
            // Dan/Atau fetch data akademik global
            const dataRisk = await fetchApi('/stats/risk-analysis'); // Data real dari server
            
            // Transform ke format scatter {x: attendance, y: grade}
            const scatterData = (dataRisk || []).map(s => ({
                x: s.attendance,
                y: s.grade,
                studentName: s.name,
                courseName: s.course
            }));

            if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();

            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Siswa Berisiko (Sampel)',
                        data: scatterData,
                        backgroundColor: '#ef4444', // Merah
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.studentName} (${ctx.raw.courseName}): Nilai ${ctx.raw.y}, Absen ${ctx.raw.x}%`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Kehadiran (%)' }, min: 0, max: 100 },
                        y: { title: { display: true, text: 'Nilai Akhir' }, min: 0, max: 100 }
                    }
                }
            });
        }

        // --- NAVIGATION & MODULES ---
        function navTo(viewId) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active', 'text-white', 'bg-white/5'));
            document.getElementById('nav-' + viewId).classList.add('active');

            if(viewId === 'registrations') loadRegistrations();
            if(viewId === 'instructors') loadInstructors();
            if(viewId === 'students') loadStudents();
            if(viewId === 'courses') loadCourses();
            if(viewId === 'announcements') loadAnnouncements();
        }

        // --- REGISTRATIONS ---
        async function loadRegistrations() {
            const res = await fetchApi('/registrations?status=pending');
            const list = (res && res.data) ? res.data : [];
            const tbody = document.getElementById('registration-table-body');
            
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-slate-400">Tidak ada registrasi pending.</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(reg => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="px-6 py-4"><div class="font-bold text-slate-700">${reg.user?.name || 'User'}</div><div class="text-xs text-slate-500">${reg.nisn}</div></td>
                    <td class="px-6 py-4 text-sm">${reg.phone_number}<br><span class="text-xs text-slate-400">${reg.school_origin}</span></td>
                    <td class="px-6 py-4 text-sm">
                         ${reg.documents ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 rounded">Uploaded</span>' : '<span class="text-xs bg-red-100 text-red-700 px-2 rounded">Missing</span>'}
                    </td>
                    <td class="px-6 py-4 text-center"><span class="bg-orange-100 text-orange-700 text-xs font-bold px-2 py-1 rounded">Pending</span></td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="approveRegistration(${reg.id})" class="text-green-600 hover:bg-green-50 p-1 rounded mr-1" title="Approve"><i class="bi bi-check-lg text-lg"></i></button>
                        <button onclick="rejectRegistration(${reg.id})" class="text-red-600 hover:bg-red-50 p-1 rounded" title="Reject"><i class="bi bi-x-lg text-lg"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function approveRegistration(id) {
            if (await Swal.fire({ title: 'Setujui Pendaftaran?', icon: 'question', showCancelButton: true }).then(r => r.isConfirmed)) {
                const res = await fetchApi(`/registrations/${id}/approve`, { method: 'POST' });
                if (res) { Swal.fire('Berhasil', 'Akun siswa dibuat', 'success'); loadRegistrations(); loadDashboardData(); }
            }
        }

        async function rejectRegistration(id) {
            const { value: reason } = await Swal.fire({ title: 'Tolak Pendaftaran?', input: 'text', inputLabel: 'Alasan Penolakan', showCancelButton: true });
            if (reason) {
                const res = await fetchApi(`/registrations/${id}/reject`, { method: 'POST', body: JSON.stringify({ reason }) });
                if (res) { Swal.fire('Ditolak', '', 'success'); loadRegistrations(); }
            }
        }

        // --- INSTRUCTORS ---
        async function loadInstructors() {
            const res = await fetchApi('/instructors');
            const list = (res && res.data) ? res.data : [];
            document.getElementById('instructors-grid').innerHTML = list.map(i => `
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold">${(i.full_name||i.name).charAt(0)}</div>
                        <div><h4 class="font-bold text-slate-800">${i.full_name || i.name}</h4><span class="text-xs bg-blue-100 text-blue-700 px-2 rounded">${i.instructor_code}</span></div>
                    </div>
                    <p class="text-sm text-slate-600"><i class="bi bi-envelope me-2"></i> ${i.email}</p>
                    <p class="text-sm text-slate-600"><i class="bi bi-mortarboard me-2"></i> ${i.specialization || '-'}</p>
                </div>`).join('');
        }

        async function submitInstructor() {
            const payload = {
                instructor_code: document.getElementById('ins-code').value,
                full_name: document.getElementById('ins-name').value,
                email: document.getElementById('ins-email').value,
                password: document.getElementById('ins-pass').value,
                phone: document.getElementById('ins-phone').value,
                specialization: document.getElementById('ins-spec').value
            };
            closeModal('modal-instructor');
            const res = await fetchApi('/instructors', { method: 'POST', body: JSON.stringify(payload) });
            if (res) { Swal.fire('Berhasil', 'Instruktur ditambahkan', 'success'); loadInstructors(); }
        }

        // --- COURSES ---
        async function loadCourses() {
            const res = await fetchApi('/courses');
            const list = (res && Array.isArray(res)) ? res : (res?.data || []);
            document.getElementById('courses-grid').innerHTML = list.map(c => `
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h4 class="font-bold text-slate-800">${c.course_name}</h4>
                    <p class="text-xs text-slate-500 mb-3">${c.course_code}</p>
                    <div class="text-xs bg-slate-100 p-2 rounded text-slate-600">Instructor: ${c.instructor?.user?.name || '-'}</div>
                </div>`).join('');
            
            // Render popular courses chart
            const ctx = document.getElementById('popularCoursesChart');
            if(ctx) {
                if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: list.slice(0,5).map(c => c.course_name),
                        datasets: [{ label: 'Peserta', data: list.slice(0,5).map(c => 10), backgroundColor: '#4f46e5', borderRadius: 4 }] // Dummy data for visualization
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }
        }

        async function openCreateCourseModal() {
            const res = await fetchApi('/instructors');
            const instructors = res?.data || [];
            const sel = document.getElementById('course-instructor');
            sel.innerHTML = instructors.map(i => `<option value="${i.id}">${i.full_name} (${i.instructor_code})</option>`).join('');
            openModal('modal-create-course');
        }

        async function submitCreateCourse() {
            const payload = {
                course_code: document.getElementById('course-code').value,
                course_name: document.getElementById('course-name').value,
                description: document.getElementById('course-desc').value,
                instructor_id: document.getElementById('course-instructor').value
            };
            closeModal('modal-create-course');
            const res = await fetchApi('/courses', { method: 'POST', body: JSON.stringify(payload) });
            if (res) { Swal.fire('Berhasil', 'Kursus dibuat', 'success'); loadCourses(); loadDashboardData(); }
        }

        // --- STUDENTS ---
        async function loadStudents(page=1, search='') {
            let url = `/students?page=${page}`;
            if(search) url += `&search=${search}`;
            
            const res = await fetchApi(url);
            const list = res?.data || [];
            
            document.getElementById('students-table-body').innerHTML = list.map(s => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="px-6 py-3 font-medium text-slate-700">${s.full_name}</td>
                    <td class="px-6 py-3 text-slate-500">${s.student_number}<br><span class="text-xs">${s.email}</span></td>
                    <td class="px-6 py-3"><span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded font-bold">${s.status}</span></td>
                </tr>
            `).join('');

            document.getElementById('student-count-info').innerText = `Total ${res.total || 0} Siswa`;
            document.getElementById('btn-prev-student').disabled = res.current_page <= 1;
            document.getElementById('btn-next-student').disabled = res.current_page >= res.last_page;
        }
        
        function debounceSearchStudent() {
            clearTimeout(studentSearchDebounce);
            studentSearchDebounce = setTimeout(() => { studentPage = 1; loadStudents(1, document.getElementById('search-student').value); }, 500);
        }
        
        function changeStudentPage(delta) {
            const newPage = studentPage + delta;
            if (newPage > 0) {
                studentPage = newPage;
                loadStudents(newPage, document.getElementById('search-student').value);
            }
        }

        // --- ANNOUNCEMENTS ---
        async function loadAnnouncements() {
            const res = await fetchApi('/announcements');
            const list = res?.data || [];
            document.getElementById('announcements-list').innerHTML = list.map(a => `
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex justify-between">
                    <div><h4 class="font-bold text-slate-800">${a.title}</h4><p class="text-sm text-slate-600">${a.content}</p></div>
                    <div class="text-xs text-slate-400">${new Date(a.created_at).toLocaleDateString()}</div>
                </div>`).join('');
        }

        async function submitAnnouncement() {
            const payload = {
                title: document.getElementById('ann-title').value,
                content: document.getElementById('ann-content').value,
                announcement_type: 'global'
            };
            closeModal('modal-announcement');
            const res = await fetchApi('/announcements', { method: 'POST', body: JSON.stringify(payload) });
            if (res) { Swal.fire('Berhasil', 'Pengumuman dipublikasi', 'success'); loadAnnouncements(); }
        }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.removeItem('auth_token'); location.reload(); }
        
        function navTo(viewId) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active', 'text-white', 'bg-white/5'));
            document.getElementById('nav-' + viewId).classList.add('active');

            if(viewId === 'registrations') loadRegistrations();
            if(viewId === 'instructors') loadInstructors();
            if(viewId === 'students') loadStudents();
            if(viewId === 'courses') loadCourses();
            if(viewId === 'announcements') loadAnnouncements();
        }

        // START APP
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
        });
    </script>
</body>
</html>