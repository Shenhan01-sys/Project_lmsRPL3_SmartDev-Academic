<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Real-Time Dashboard - SmartDev LMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a', // Slate 900
                        accent: '#4f46e5', // Indigo 600
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        sidebar: '#1e293b',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        /* Sidebar Navigation */
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #94a3b8;
            transition: all 0.2s;
            border-right: 3px solid transparent;
            cursor: pointer;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-link.active {
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.2) 0%, transparent 100%);
            color: #fff;
            border-right-color: #4f46e5;
        }

        /* Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden text-slate-800">

    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mb-3"></div>
            <span class="text-slate-600 font-bold text-sm tracking-wider">MENGAMBIL DATA...</span>
        </div>
    </div>

    <aside class="w-64 bg-sidebar text-white hidden md:flex flex-col shadow-2xl z-20 shrink-0 transition-all duration-300">
        <div class="p-6 border-b border-white/10 flex items-center gap-3">
            <div class="w-8 h-8 bg-accent rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <i class="bi bi-shield-lock-fill text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">SmartDev</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Admin Panel</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <div class="px-3 mb-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Menu Utama</div>
            <div onclick="nav('dashboard')" id="btn-dashboard" class="nav-link active">
                <i class="bi bi-grid-1x2 me-3 text-lg"></i> <span class="font-medium">Dashboard</span>
            </div>
            <div onclick="nav('registrations')" id="btn-registrations" class="nav-link relative">
                <i class="bi bi-person-plus me-3 text-lg"></i> <span class="font-medium">Registrasi Siswa</span>
                <span id="badge-pending" class="absolute right-3 bg-danger text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden shadow-sm">0</span>
            </div>

            <div class="px-3 mb-2 mt-6 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Manajemen</div>
            <div onclick="nav('instructors')" id="btn-instructors" class="nav-link">
                <i class="bi bi-person-video3 me-3 text-lg"></i> <span class="font-medium">Instruktur</span>
            </div>
            <div onclick="nav('students')" id="btn-students" class="nav-link">
                <i class="bi bi-people me-3 text-lg"></i> <span class="font-medium">Siswa & User</span>
            </div>
            <div onclick="nav('courses')" id="btn-courses" class="nav-link">
                <i class="bi bi-journal-bookmark-fill me-3 text-lg"></i> <span class="font-medium">Kursus</span>
            </div>

            <div class="px-3 mb-2 mt-6 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Lainnya</div>
            <div onclick="nav('announcements')" id="btn-announcements" class="nav-link">
                <i class="bi bi-megaphone me-3 text-lg"></i> <span class="font-medium">Pengumuman</span>
            </div>
        </nav>

        <div class="p-4 border-t border-white/10 bg-slate-900/50">
            <button onclick="logout()" class="w-full py-2.5 bg-white/5 hover:bg-red-500/20 text-slate-300 hover:text-red-400 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 group">
                <i class="bi bi-box-arrow-right group-hover:scale-110 transition-transform"></i> KELUAR SISTEM
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-50">
        <div class="md:hidden bg-sidebar text-white p-4 flex justify-between items-center shadow-md z-30 shrink-0">
            <span class="font-bold flex items-center gap-2"><i class="bi bi-shield-lock-fill text-accent"></i> Admin Panel</span>
            <button onclick="alert('Menu mobile belum aktif')" class="text-xl"><i class="bi bi-list"></i></button>
        </div>

        <div id="main-scroll" class="flex-1 overflow-y-auto p-6 lg:p-8 scroll-smooth">

            <section id="view-dashboard" class="page-view fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 tracking-tight">Dashboard Eksekutif</h2>
                        <p class="text-slate-500 mt-1 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            Sistem Terhubung & Online
                        </p>
                    </div>
                    <button onclick="loadDashboardData()" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-accent hover:border-accent shadow-sm transition-all text-sm font-medium flex items-center gap-2">
                        <i class="bi bi-arrow-clockwise"></i> Segarkan Data
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total User</p>
                            <h3 class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-users">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-blue-50 to-transparent group-hover:from-blue-100 transition-all"></div>
                        <i class="bi bi-people-fill absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-blue-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group cursor-pointer" onclick="nav('registrations')">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Registrasi Pending</p>
                            <h3 class="text-3xl font-extrabold text-orange-500 mt-2" id="stat-pending">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-orange-50 to-transparent group-hover:from-orange-100 transition-all"></div>
                        <i class="bi bi-person-plus-fill absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-orange-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Kursus Aktif</p>
                            <h3 class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-courses">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-emerald-50 to-transparent group-hover:from-emerald-100 transition-all"></div>
                        <i class="bi bi-book-half absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-emerald-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Instruktur</p>
                            <h3 class="text-3xl font-extrabold text-slate-800 mt-2" id="stat-instructors">0</h3>
                        </div>
                        <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-indigo-50 to-transparent group-hover:from-indigo-100 transition-all"></div>
                        <i class="bi bi-person-video3 absolute right-4 top-1/2 -translate-y-1/2 text-4xl text-indigo-200 group-hover:scale-110 transition-transform"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">Tren Pendaftaran User</h4>
                                <p class="text-xs text-slate-500">Berdasarkan data real-time tahun ini</p>
                            </div>
                            <div class="p-2 bg-blue-50 rounded-lg text-accent"><i class="bi bi-graph-up"></i></div>
                        </div>
                        <div class="h-72 w-full"><canvas id="registrationChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="font-bold text-slate-800 text-lg">Distribusi Role</h4>
                            <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i class="bi bi-pie-chart-fill"></i></div>
                        </div>
                        <div class="h-64 flex justify-center items-center relative flex-1">
                            <canvas id="userDistChart"></canvas>
                        </div>
                        <div class="mt-4 text-center text-xs text-slate-400">Total data dari database</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    <i class="bi bi-exclamation-triangle-fill text-red-500"></i> Early Warning
                                </h4>
                                <p class="text-xs text-slate-500">Siswa berisiko (Nilai Rendah)</p>
                            </div>
                            <span class="px-2 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-full animate-pulse">Live Data</span>
                        </div>

                        <div class="flex-1 overflow-y-auto pr-2 space-y-3 max-h-80 custom-scrollbar" id="ews-list">
                            <div class="text-center py-8 text-slate-400 text-sm">Menghitung risiko akademik...</div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-100 text-[10px] text-slate-400 italic text-center">
                            *Mengambil data real-time dari Enrollments dengan Nilai < 60
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">Analisis Akademik</h4>
                                <p class="text-xs text-slate-500">Distribusi Siswa berdasarkan Nilai Akhir (Y)</p>
                            </div>
                            <div class="flex gap-2">
                                <span class="flex items-center gap-1 text-[10px] text-slate-500"><span class="w-2 h-2 rounded-full bg-emerald-400"></span> Aman (>60)</span>
                                <span class="flex items-center gap-1 text-[10px] text-slate-500"><span class="w-2 h-2 rounded-full bg-red-400"></span> Berisiko (<60)</span>
                            </div>
                        </div>
                        <div class="h-80 w-full relative">
                            <canvas id="academicScatterChart"></canvas>
                        </div>
                    </div>
                </div>

            </section>

            <section id="view-registrations" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Registrasi Siswa</h2>
                        <p class="text-slate-500 text-sm mt-1">Validasi calon siswa yang mendaftar.</p>
                    </div>
                    <button onclick="loadRegistrations()" class="p-2 bg-white border rounded-lg text-slate-600 hover:text-accent"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-4 font-semibold">Calon Siswa</th>
                                    <th class="px-6 py-4 font-semibold">Kontak</th>
                                    <th class="px-6 py-4 font-semibold">Dokumen</th>
                                    <th class="px-6 py-4 font-semibold">Tgl Daftar</th>
                                    <th class="px-6 py-4 text-center font-semibold">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="registration-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-instructors" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Daftar Instruktur</h2>
                    <button onclick="openModal('modal-instructor')" class="bg-accent hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/30 flex items-center gap-2 transition-all">
                        <i class="bi bi-plus-lg"></i> Tambah Instruktur
                    </button>
                </div>
                <div id="instructors-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </section>

            <section id="view-students" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Database Siswa</h2>
                    </div>
                    <div class="relative flex gap-2">
                        <select id="filter-student-status" onchange="loadStudents()" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Semua Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" id="search-student" onkeyup="debounceSearchStudent()" placeholder="Cari siswa..." class="pl-4 pr-10 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent w-64">
                        <i class="bi bi-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="bg-slate-50 border-b text-xs uppercase text-slate-500 font-bold">
                            <tr>
                                <th class="px-6 py-4">Nama Lengkap</th>
                                <th class="px-6 py-4">Email</th>
                                <th class="px-6 py-4">NIS/NIM</th>
                                <th class="px-6 py-4">Orang Tua</th>
                                <th class="px-6 py-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="5" class="p-8 text-center text-slate-400">Memuat data siswa...</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 text-xs text-slate-500 flex justify-between items-center">
                        <span id="student-count-info">0 Data</span>
                        <div class="flex gap-1">
                            <button onclick="changeStudentPage(-1)" class="px-3 py-1 border rounded hover:bg-white disabled:opacity-50" id="btn-prev-student">Prev</button>
                            <button onclick="changeStudentPage(1)" class="px-3 py-1 border rounded hover:bg-white disabled:opacity-50" id="btn-next-student">Next</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-courses" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Manajemen Kursus</h2>
                    <button onclick="openCreateCourseModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                        <i class="bi bi-plus-lg"></i> Buat Kursus
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-8">
                    <h4 class="font-bold text-slate-700 mb-4">Top 5 Kursus Terpopuler</h4>
                    <div class="h-64 w-full"><canvas id="popularCoursesChart"></canvas></div>
                </div>
                <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="view-announcements" class="page-view hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Pengumuman Global</h2>
                    <button onclick="openModal('modal-announcement')" class="bg-slate-800 hover:bg-slate-900 text-white px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="bi bi-megaphone-fill"></i> Buat Baru
                    </button>
                </div>
                <div id="announcements-list" class="space-y-4"></div>
            </section>

            <section id="view-instructor-detail" class="page-view hidden fade-in">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="nav('instructors')" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors">
                        <i class="bi bi-arrow-left text-lg"></i>
                    </button>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold text-slate-800">Detail Instruktur</h2>
                        <p class="text-slate-500 text-sm">Informasi lengkap dan daftar kursus</p>
                    </div>
                    <button id="btn-edit-instructor-detail" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-500/30">
                        <i class="bi bi-pencil-square"></i> Edit Data
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-br from-slate-800 to-slate-900"></div>
                            <div class="relative z-10">
                                <div id="det-ins-avatar" class="w-24 h-24 rounded-full bg-white border-4 border-white text-slate-800 flex items-center justify-center text-4xl font-bold mx-auto mb-4 shadow-md">I</div>
                                <h3 id="det-ins-name" class="text-xl font-bold text-slate-800 mb-1">Nama Instruktur</h3>
                                <p id="det-ins-code" class="text-sm font-mono text-blue-600 bg-blue-50 inline-block px-2 py-1 rounded mb-4">CODE</p>

                                <div class="grid grid-cols-2 gap-4 border-t border-slate-100 pt-4 text-left">
                                    <div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Spesialisasi</p><p id="det-ins-spec" class="text-sm font-medium text-slate-700">-</p></div>
                                    <div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Pendidikan</p><p id="det-ins-edu" class="text-sm font-medium text-slate-700">-</p></div>
                                    <div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Pengalaman</p><p id="det-ins-exp" class="text-sm font-medium text-slate-700">-</p></div>
                                    <div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Status</p><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Active</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="bi bi-person-lines-fill text-slate-400"></i> Kontak</h4>
                            <div class="space-y-3">
                                <div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Email</p><p id="det-ins-email" class="text-sm font-medium text-slate-700 break-all">-</p></div>
                                <div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Telepon</p><p id="det-ins-phone" class="text-sm font-medium text-slate-700">-</p></div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="bi bi-card-text text-slate-400"></i> Bio</h4>
                            <p id="det-ins-bio" class="text-sm text-slate-600 leading-relaxed">-</p>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                                <div class="w-12 h-12 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center text-2xl"><i class="bi bi-journal-bookmark-fill"></i></div>
                                <div><p class="text-sm text-slate-500 font-medium">Total Kursus</p><h4 id="det-ins-courses" class="text-2xl font-bold text-slate-800">0</h4></div>
                            </div>
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                                <div class="w-12 h-12 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl"><i class="bi bi-people-fill"></i></div>
                                <div><p class="text-sm text-slate-500 font-medium">Kapasitas Maksimal Siswa</p><h4 id="det-ins-students" class="text-2xl font-bold text-slate-800">0</h4></div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                                <h4 class="font-bold text-slate-800">Daftar Kursus</h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th class="px-6 py-3">Nama Kursus</th>
                                            <th class="px-6 py-3">Kode</th>
                                            <th class="px-6 py-3 text-center">Siswa</th>
                                            <th class="px-6 py-3 text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="det-ins-course-list" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <div id="modal-create-course" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Buat Kursus Baru</h3>
                <button onclick="closeModal('modal-create-course')" class="text-slate-400 hover:text-red-500"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="p-6">
                <form onsubmit="event.preventDefault(); submitCreateCourse();">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kode</label><input type="text" id="create-course-code" class="w-full border rounded p-2 text-sm" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama</label><input type="text" id="create-course-name" class="w-full border rounded p-2 text-sm" required></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Instruktur</label>
                        <select id="create-course-instructor" class="w-full border rounded p-2 text-sm bg-white" required>
                            <option value="">Memuat data...</option>
                        </select>
                    </div>
                    <div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Deskripsi</label><textarea id="create-course-desc" class="w-full border rounded p-2 text-sm" rows="3"></textarea></div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeModal('modal-create-course')" class="px-4 py-2 text-slate-600 text-sm font-bold">Batal</button>
                        <button type="submit" class="px-6 py-2 bg-emerald-600 text-white rounded text-sm font-bold hover:bg-emerald-700">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-edit-course" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Edit Kursus</h3>
                <button onclick="closeModal('modal-edit-course')" class="text-slate-400 hover:text-red-500"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="p-6">
                <form onsubmit="event.preventDefault(); updateCourse();">
                    <input type="hidden" id="edit-course-id">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kode</label><input type="text" id="edit-course-code" class="w-full border rounded p-2 text-sm" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama</label><input type="text" id="edit-course-name" class="w-full border rounded p-2 text-sm" required></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Instruktur</label>
                            <select id="edit-course-instructor" class="w-full border rounded p-2 text-sm bg-white" required>
                                <option value="">Memuat...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label>
                            <select id="edit-course-status" class="w-full border rounded p-2 text-sm bg-white">
                                <option value="Published">Published</option>
                                <option value="Draft">Draft</option>
                                <option value="Archived">Archived</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Deskripsi</label><textarea id="edit-course-desc" class="w-full border rounded p-2 text-sm" rows="3"></textarea></div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeModal('modal-edit-course')" class="px-4 py-2 text-slate-600 text-sm font-bold">Batal</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded text-sm font-bold hover:bg-blue-700">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-instructor" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-xl w-full max-w-2xl shadow-2xl overflow-hidden my-8">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Tambah Instruktur Baru</h3>
                <button onclick="closeModal('modal-instructor')" class="text-slate-400 hover:text-red-500"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="p-6">
                <form onsubmit="event.preventDefault(); submitInstructor();">
                    <h6 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Akun & Login</h6>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label><input type="text" id="ins-name" class="w-full border rounded p-2 text-sm" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label><input type="email" id="ins-email" class="w-full border rounded p-2 text-sm" required></div>
                    </div>
                    <div class="mb-6"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Default</label><input type="password" id="ins-pass" class="w-full border rounded p-2 text-sm" placeholder="Min. 8 Karakter" required></div>
                    <h6 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Profil Instruktur</h6>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP / Kode</label><input type="text" id="ins-code" class="w-full border rounded p-2 text-sm" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">No. Telepon</label><input type="text" id="ins-phone" class="w-full border rounded p-2 text-sm"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Spesialisasi</label><input type="text" id="ins-spec" class="w-full border rounded p-2 text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pendidikan Terakhir</label><select id="ins-edu" class="w-full border rounded p-2 text-sm">
                                <option value="S1">S1</option>
                                <option value="S2">S2</option>
                                <option value="S3">S3</option>
                                <option value="Lainnya">Lainnya</option>
                            </select></div>
                    </div>
                    <div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pengalaman (Tahun)</label><input type="number" id="ins-exp" class="w-full border rounded p-2 text-sm" value="0"></div>
                    <div class="mb-6"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bio Singkat</label><textarea id="ins-bio" class="w-full border rounded p-2 text-sm" rows="3"></textarea></div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModal('modal-instructor')" class="px-4 py-2 text-slate-500 font-medium hover:bg-slate-50 rounded text-sm">Batal</button>
                        <button type="submit" class="px-6 py-2 bg-accent text-white rounded font-bold text-sm shadow-lg shadow-indigo-500/30">Simpan Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-edit-instructor" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-xl w-full max-w-2xl shadow-2xl overflow-hidden my-8">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Edit Instruktur</h3>
                <button onclick="closeModal('modal-edit-instructor')" class="text-slate-400 hover:text-red-500"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="p-6">
                <form onsubmit="event.preventDefault(); updateInstructor();">
                    <input type="hidden" id="edit-ins-id">
                    <h6 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Profil Utama</h6>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label><input type="text" id="edit-ins-name" class="w-full border rounded p-2 text-sm" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label><input type="email" id="edit-ins-email" class="w-full border rounded p-2 text-sm" required></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP / Kode</label><input type="text" id="edit-ins-code" class="w-full border rounded p-2 text-sm" disabled></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">No. Telepon</label><input type="text" id="edit-ins-phone" class="w-full border rounded p-2 text-sm"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Spesialisasi</label><input type="text" id="edit-ins-spec" class="w-full border rounded p-2 text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label>
                            <select id="edit-ins-status" class="w-full border rounded p-2 text-sm">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="resigned">Resigned</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pendidikan Terakhir</label><select id="edit-ins-edu" class="w-full border rounded p-2 text-sm">
                                <option value="S1">S1</option>
                                <option value="S2">S2</option>
                                <option value="S3">S3</option>
                                <option value="Lainnya">Lainnya</option>
                            </select></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pengalaman (Tahun)</label><input type="number" id="edit-ins-exp" class="w-full border rounded p-2 text-sm" value="0"></div>
                    </div>
                    <div class="mb-6"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bio Singkat</label><textarea id="edit-ins-bio" class="w-full border rounded p-2 text-sm" rows="3"></textarea></div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModal('modal-edit-instructor')" class="px-4 py-2 text-slate-500 font-medium hover:bg-slate-50 rounded text-sm">Batal</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded font-bold text-sm shadow-lg shadow-blue-500/30">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-announcement" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Buat Pengumuman</h3>
            <form id="formAnnouncement" onsubmit="event.preventDefault(); submitAnnouncement();">
                <div class="space-y-3">
                    <input type="text" id="annTitle" placeholder="Judul" class="w-full border rounded p-2 text-sm" required>
                    <textarea id="annContent" placeholder="Isi Pengumuman" class="w-full border rounded p-2 text-sm" rows="3" required></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="annCourseId" class="w-full border rounded p-2 text-sm bg-white"></select>
                        <select id="annPriority" class="w-full border rounded p-2 text-sm bg-white">
                            <option value="normal">Normal</option>
                            <option value="high">Penting</option>
                            <option value="urgent">Mendesak</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="datetime-local" id="annPublishedAt" class="w-full border rounded p-2 text-sm">
                        <select id="annStatus" class="w-full border rounded p-2 text-sm bg-white">
                            <option value="published">Terbit</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal('modal-announcement')" class="px-4 py-2 text-slate-500 text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-accent text-white rounded text-sm font-bold hover:bg-indigo-700">Kirim</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'https://portohansgunawan.my.id/api/v1';
        let authToken = localStorage.getItem('auth_token');
        let studentPage = 1;
        let studentSearchDebounce;

        let store = {
            users: [],
            courses: [],
            instructors: [],
            registrations: [],
            announcements: [],
            stats: {}
        };

        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
        });

        async function initAuth() {
            if (!authToken) {
                const { value: token } = await Swal.fire({
                    title: 'Admin Login',
                    text: 'Masukkan Token API:',
                    input: 'text',
                    icon: 'info',
                    confirmButtonText: 'Masuk',
                    allowOutsideClick: false,
                    inputValidator: (value) => { if (!value) return 'Token wajib diisi!' }
                });
                if (token) {
                    authToken = token;
                    localStorage.setItem('auth_token', token);
                }
            }
            loadDashboardData();
        }

        function getHeaders(isFormData = false) {
            const headers = {
                'Accept': 'application/json',
                'Authorization': `Bearer ${authToken}`,
                'ngrok-skip-browser-warning': 'true'
            };
            if (!isFormData) headers['Content-Type'] = 'application/json';
            return headers;
        }
        
        // Fetcher Cerdas
        async function fetchApi(endpoint, options = {}) {
            // Tampilkan loader jika bukan method GET (agar UX lebih responsif)
            if (options.method && options.method !== 'GET') showLoader(true);
        
            try {
                const isFormData = options.body instanceof FormData;
                // Handle URL absolute vs relative
                const url = endpoint.startsWith('http') ? endpoint : (API_BASE + endpoint);
                
                const res = await fetch(url, {
                    ...options,
                    headers: { 
                        ...getHeaders(isFormData), 
                        ...options.headers 
                    }
                });
        
                if (res.status === 401) {
                    localStorage.removeItem('auth_token');
                    location.reload(); // Force logout jika token expired
                    return null;
                }
        
                // Handle No Content
                if (res.status === 204) return true;
        
                const json = await res.json().catch(() => null);
                if (!res.ok) throw new Error(json?.message || `HTTP Error ${res.status}`);
                
                return json;
            } catch (err) {
                console.error(`API Error ${endpoint}:`, err);
                Swal.fire("Error", err.message, "error");
                return null;
            } finally {
                showLoader(false);
            }
        }

        async function loadDashboardData() {
            showLoader(true);
            try {
                // Fetch Stats & Initial Data
                const [statsReg, statsUser, statsAcademic, statsFinance, statsSummary, users, courses, registrations, instructors, announcements] = await Promise.all([
                    fetchApi('/stats/registrations'),
                    fetchApi('/stats/users'),
                    fetchApi('/stats/academic'),
                    fetchApi('/stats/finance'),
                    fetchApi('/stats/summary'),
                    fetchApi('/users?per_page=1'),
                    fetchApi('/courses'), 
                    fetchApi('/registrations?status=pending').catch(e => ({ total: 0 })),
                    fetchApi('/instructors?per_page=1'),
                    fetchApi('/announcements?per_page=5')
                ]);

                // Store Data
                store.stats = {
                    registrations: statsReg,
                    users: statsUser,
                    academic: statsAcademic,
                    finance: statsFinance,
                    summary: statsSummary
                };

                // Update Counts
                if (statsSummary) {
                    document.getElementById('stat-users').innerText = statsSummary.total_users || 0;
                    document.getElementById('stat-courses').innerText = statsSummary.active_courses || 0;
                    document.getElementById('stat-pending').innerText = statsSummary.pending_registrations || 0;
                    document.getElementById('stat-instructors').innerText = statsSummary.total_instructors || 0;
                    
                    const pendingCount = statsSummary.pending_registrations || 0;
                    const badge = document.getElementById('badge-pending');
                    if (badge) {
                        badge.innerText = pendingCount;
                        badge.classList.toggle('hidden', pendingCount === 0);
                    }
                } else {
                    document.getElementById('stat-users').innerText = users?.total || 0;
                    document.getElementById('stat-courses').innerText = (Array.isArray(courses) ? courses.length : (courses?.total || 0));
                    document.getElementById('stat-instructors').innerText = instructors?.total || 0;
                    const pendingCount = registrations?.total || 0;
                    document.getElementById('stat-pending').innerText = pendingCount;
                }

                // Update Standard Charts
                updateCharts();

                // === NEW FEATURES INIT ===
                loadRealEWSData(); // Fetch real data from /enrollments
                loadRealScatterData(); // Fetch real data for scatter plot

                // Load initial lists for other views
                store.announcements = announcements?.data || [];
                renderAnnouncements();
                
                store.courses = (Array.isArray(courses)) ? courses : (courses?.data || []);
                renderCourses();
                updatePopularCoursesChart();

            } catch (e) { console.error("Init Error", e); }
            finally { showLoader(false); }
        }

        // ==========================================
        // NEW FEATURE 1: REAL EARLY WARNING SYSTEM
        // Menggunakan data dari endpoint /enrollments
        // ==========================================
        async function loadRealEWSData() {
            const listContainer = document.getElementById('ews-list');
            listContainer.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-500 mx-auto"></div></div>';

            try {
                // Fetch enrollments karena ini satu-satunya endpoint publik yang punya nilai (final_grade) dan nama siswa
                // Idealnya: Gunakan pagination atau filter server-side jika data besar. 
                // Disini kita fetch semua (default pagination) untuk demo.
                const enrollments = await fetchApi('/enrollments'); 
                
                if (!enrollments || enrollments.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Data enrollment kosong.</p>';
                    return;
                }

                // Filter siswa berisiko: Nilai < 60 (dan bukan null/0 yang mungkin belum dinilai)
                // Kita anggap nilai 0-10 sebagai belum dinilai, jadi ambil range 10-60 untuk "Berisiko"
                // Atau tampilkan semua yang < 60 jika ingin ketat.
                const atRisk = enrollments.filter(e => {
                    const grade = parseFloat(e.final_grade || 0);
                    return grade > 0 && grade < 60; // Filter nilai rendah tapi sudah ada nilai
                }).slice(0, 10); // Ambil 10 teratas

                if (atRisk.length === 0) {
                    listContainer.innerHTML = '<div class="flex flex-col items-center py-6 text-slate-400"><i class="bi bi-check-circle text-4xl text-emerald-100 mb-2"></i><span class="text-xs">Tidak ada siswa berisiko saat ini.</span></div>';
                    return;
                }

                let html = '';
                atRisk.forEach(e => {
                    const studentName = e.student?.user?.name || 'Siswa Tanpa Nama';
                    const courseName = e.course?.course_name || 'Kursus';
                    const grade = parseFloat(e.final_grade).toFixed(1);
                    
                    html += `
                    <div class="flex items-start gap-3 p-3 bg-red-50/30 hover:bg-red-50 rounded-lg transition-all border border-red-100 group">
                        <div class="w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center font-bold text-xs shrink-0 shadow-sm mt-1">
                            ${studentName.charAt(0)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h5 class="font-bold text-slate-800 text-xs truncate pr-2">${studentName}</h5>
                                <span class="text-[10px] font-bold text-red-600 bg-white px-1.5 py-0.5 rounded border border-red-200">Nilai: ${grade}</span>
                            </div>
                            <p class="text-[10px] text-slate-500 truncate mb-1">${courseName}</p>
                            <div class="w-full bg-red-200 rounded-full h-1">
                                <div class="bg-red-500 h-1 rounded-full" style="width: ${grade}%"></div>
                            </div>
                        </div>
                    </div>
                    `;
                });

                listContainer.innerHTML = html;

            } catch (error) {
                console.error("EWS Error", error);
                listContainer.innerHTML = '<p class="text-center text-xs text-red-400 py-4">Gagal memuat data risiko.</p>';
            }
        }

        // ==========================================
        // NEW FEATURE 2: REAL DATA SCATTER PLOT
        // ==========================================
        async function loadRealScatterData() {
            const ctx = document.getElementById('academicScatterChart');
            if (!ctx) return;
        
            try {
                // Fetch all enrollments dengan detail student dan course
                const enrollmentsRes = await fetchApi('/enrollments?per_page=200');
                const enrollments = Array.isArray(enrollmentsRes) ? enrollmentsRes : [];
        
                console.log(' Total enrollments:', enrollments.length);
        
                if (enrollments.length === 0) {
                    console.log('No enrollments found for scatter plot');
                    return;
                }
        
                // Untuk setiap enrollment, fetch attendance stats
                const scatterDataPromises = enrollments.map(async (enrollment) => {
                    try {
                        const studentId = enrollment.student_id;
                        const courseId = enrollment.course_id;
                        const finalGrade = parseFloat(enrollment.final_grade || 0);
                        
                        // Skip jika belum ada grade
                        if (finalGrade === 0) {
                            return null;
                        }
                        
                        // Fetch attendance stats untuk COURSE YANG SAMA
                        const statsRes = await fetchApi(
                            `/attendance-records/student/${studentId}/course/${courseId}/stats`
                        );
                        
                        //  Cek jika statsRes null atau total_sessions = 0
                        if (!statsRes || statsRes.total_sessions === 0) {
                            // Tetap tampilkan dengan attendance=0
                            return {
                                x: 0, // Belum ada attendance record
                                y: finalGrade,
                                studentName: enrollment.student?.full_name || 'Unknown',
                                courseName: enrollment.course?.course_name || 'Unknown',
                                hasAttendance: false
                            };
                        }
                        
                        const attendancePercentage = statsRes.attendance_percentage ?? 0;
                                            
                        return {
                            x: attendancePercentage,
                            y: finalGrade,
                            studentName: enrollment.student?.full_name || 'Unknown',
                            courseName: enrollment.course?.course_name || 'Unknown',
                            hasAttendance: true
                        };
                        
                    } catch (error) {
                        console.warn(` Error for enrollment ${enrollment.id}:`, error);
                        return null;
                    }
                });
        
                // Wait untuk semua requests selesai
                const scatterDataRaw = await Promise.all(scatterDataPromises);
                
                // Filter null values
                const scatterData = scatterDataRaw.filter(item => item !== null);
        
                console.log(' Valid scatter data points:', scatterData.length);
                console.log(' Sample data (first 5):', scatterData.slice(0, 5));
                
                //  DEBUGGING: Hitung berapa yang punya attendance vs tidak
                const withAttendance = scatterData.filter(d => d.hasAttendance).length;
                const withoutAttendance = scatterData.filter(d => !d.hasAttendance).length;
                console.log(` Data breakdown:`);
                console.log(`   - With attendance data: ${withAttendance}`);
                console.log(`   - Without attendance data (x=0): ${withoutAttendance}`);
                
                //  Show beberapa contoh yang x=0
                const zeroAttendance = scatterData.filter(d => d.x === 0).slice(0, 3);
                console.log(' Sample students with x=0:', zeroAttendance);
        
                if (scatterData.length === 0) {
                    console.log('No valid data for scatter plot (no grades or attendance records yet)');
                    // Tampilkan pesan di UI
                    const container = document.querySelector('#academicScatterChart').parentElement;
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b;">
                            <div style="text-align: center;">
                                <i class="fas fa-chart-scatter" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                                <p>Belum ada data untuk ditampilkan</p>
                                <p style="font-size: 12px; opacity: 0.7;">Data akan muncul setelah ada nilai dan kehadiran siswa</p>
                            </div>
                        </div>
                    `;
                    return;
                }
        
                // Destroy chart lama jika ada
                if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();
        
                // Create new scatter chart dengan data real
                new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: 'Distribusi Siswa (Kehadiran vs Nilai)',
                                data: scatterData,
                                backgroundColor: (ctx) => {
                                    const v = ctx.raw;
                                    if (!v) return '#10b981';
                                    
                                    //  Merah jika nilai < 60
                                    if (v.y < 60) return '#ef4444';
                                    //  Kuning jika 60-75
                                    if (v.y < 75) return '#f59e0b';
                                    //  Hijau jika > 75
                                    return '#10b981';
                                },
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                // Tambahkan border untuk yang tidak punya attendance
                                borderColor: (ctx) => {
                                    const v = ctx.raw;
                                    if (!v || !v.hasAttendance) return '#94a3b8'; // Abu-abu border untuk yang x=0
                                    return 'transparent';
                                },
                                borderWidth: (ctx) => {
                                    const v = ctx.raw;
                                    if (!v || !v.hasAttendance) return 2;
                                    return 0;
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const data = ctx.raw;
                                        const lines = [
                                            `Siswa: ${data.studentName}`,
                                            `Course: ${data.courseName}`,
                                            `Kehadiran: ${data.x.toFixed(1)}%`,
                                            `Nilai Akhir: ${data.y.toFixed(1)}`
                                        ];
                                        
                                        if (!data.hasAttendance) {
                                            lines.push(' Belum ada data kehadiran');
                                        }
                                        
                                        return lines;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { 
                                    display: true, 
                                    text: 'Persentase Kehadiran (%)', 
                                    color: '#94a3b8', 
                                    font: {size: 11, weight: 'bold'} 
                                },
                                min: 0, 
                                max: 100, 
                                grid: { color: '#f1f5f9' }
                            },
                            y: {
                                title: { 
                                    display: true, 
                                    text: 'Nilai Akhir', 
                                    color: '#94a3b8', 
                                    font: {size: 11, weight: 'bold'} 
                                },
                                min: 0, 
                                max: 100, 
                                grid: { color: '#f1f5f9' }
                            }
                        }
                    }
                });
        
                console.log(` Scatter plot loaded with ${scatterData.length} data points`);
        
            } catch (error) {
                console.error(' Error loading scatter data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Gagal memuat data scatter plot: ' + error.message
                });
            }
        }

        // --- EXISTING CHARTS & LOGIC (UNCHANGED) ---

        function updateCharts() {
            // Registration Chart (Line)
            const ctxReg = document.getElementById('registrationChart');
            if (ctxReg && store.stats.registrations) {
                if (Chart.getChart(ctxReg)) Chart.getChart(ctxReg).destroy();
                new Chart(ctxReg, {
                    type: 'line',
                    data: {
                        labels: store.stats.registrations.labels,
                        datasets: [{
                            label: 'Pendaftaran',
                            data: store.stats.registrations.data,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: { 
                            y: { grid: { borderDash: [4, 4] }, beginAtZero: true },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // User Distribution Chart (Doughnut)
            const ctxDist = document.getElementById('userDistChart');
            if (ctxDist && store.stats.users) {
                if (Chart.getChart(ctxDist)) Chart.getChart(ctxDist).destroy();
                const u = store.stats.users;
                new Chart(ctxDist, {
                    type: 'doughnut',
                    data: {
                        labels: ['Siswa', 'Instruktur', 'Admin', 'Ortu'],
                        datasets: [{
                            data: [u.student, u.instructor, u.admin, u.parent],
                            backgroundColor: ['#4f46e5', '#f59e0b', '#0f172a', '#10b981'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
                });
            }
        }

        // --- NAVIGATION & VIEWS ---
        function nav(viewId) {
            console.log('Navigating to:', viewId); // Debug log
            
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            
            const targetView = document.getElementById(`view-${viewId}`);
            if (!targetView) {
                console.error(`Element with id "view-${viewId}" not found!`);
                return;
            }
            
            targetView.classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active', 'text-white', 'bg-white/5'));
        
            const btn = document.getElementById('btn-' + viewId);
            if (btn) btn.classList.add('active');
        
            if (viewId === 'registrations') loadRegistrations();
            if (viewId === 'instructors') loadInstructors();
            if (viewId === 'students') loadStudents();
            if (viewId === 'courses') loadCourses();
            if (viewId === 'announcements') loadAnnouncements();
        }


        // --- DATA LOADERS ---
        async function loadInstructors() {
            const grid = document.getElementById('instructors-grid');
            grid.innerHTML = '<div class="col-span-full text-center p-8 text-slate-400">Memuat instruktur...</div>';
            const res = await fetchApi('/instructors');
            store.instructors = (res && res.data) ? res.data : (Array.isArray(res) ? res : []);
            renderInstructors();
        }
        async function loadCourses() {
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = '<div class="col-span-full text-center p-8 text-slate-400">Memuat kursus...</div>';
            const res = await fetchApi('/courses');
            store.courses = (res && res.data) ? res.data : (Array.isArray(res) ? res : []);
            renderCourses();
            updatePopularCoursesChart();
        }
        
        async function loadAnnouncements() {
            const list = document.getElementById('announcements-list');
            list.innerHTML = '<div class="text-center p-8 text-slate-400">Memuat pengumuman...</div>';
            const res = await fetchApi('/announcements');
            store.announcements = (res && res.data) ? res.data : (Array.isArray(res) ? res : []);
            renderAnnouncements();
        }

        async function updatePopularCoursesChart() {
            const ctx = document.getElementById('popularCoursesChart');
            if (!ctx) return;

            let labels = [];
            let data = [];
            let label = 'Rata-rata Nilai';
            let color = '#10b981';

            try {
                const res = await fetchApi('/stats/academic');
                const academicData = (res && Array.isArray(res)) ? res : [];

                if (academicData.length > 0) {
                    const sorted = academicData.sort((a, b) => (b.average_score || 0) - (a.average_score || 0)).slice(0, 5);
                    labels = sorted.map(c => c.course_name);
                    data = sorted.map(c => c.average_score || 0);
                }
            } catch (e) { console.error(e); }

            if (labels.length === 0 && store.courses && store.courses.length > 0) {
                label = 'Jumlah Siswa';
                color = '#4f46e5';
                const sorted = [...store.courses].sort((a, b) => (b.students_count || 0) - (a.students_count || 0)).slice(0, 5);
                labels = sorted.map(c => c.course_name || c.name);
                data = sorted.map(c => c.students_count || 0);
            }

            if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderRadius: 6,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: label === 'Rata-rata Nilai' ? 100 : undefined,
                            grid: { borderDash: [2, 4], color: '#e2e8f0' }
                        },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- STUDENTS LOGIC ---
        async function loadStudents(page = 1) {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400">Memuat data siswa...</td></tr>';

            const status = document.getElementById('filter-student-status').value;
            const search = document.getElementById('search-student').value;

            const params = new URLSearchParams({ per_page: 10, page: page });
            if (status) params.append('status', status);
            if (search) params.append('search', search);

            const res = await fetchApi(`/students?${params.toString()}`);

            if (!res || !res.data || res.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400">Tidak ada data siswa ditemukan.</td></tr>';
                document.getElementById('student-count-info').innerText = '0 Data';
                updatePagination(0, 1);
                return;
            }

            const students = res.data;
            studentPage = res.current_page;
            const totalPages = res.last_page;
            const total = res.total;

            document.getElementById('student-count-info').innerText = `Menampilkan ${res.from || 0}-${res.to || 0} dari ${total} siswa`;
            updatePagination(totalPages, studentPage);

            tbody.innerHTML = students.map(s => `
                <tr class="border-b hover:bg-slate-50 group">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">
                                ${(s.full_name || s.name || 'S').charAt(0)}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800">${s.full_name || s.name}</div>
                                <div class="text-xs text-slate-400">${s.student_number || 'No NIS'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600">${s.email || (s.user ? s.user.email : '-')}</td>
                    <td class="px-6 py-4 text-sm text-slate-600 font-mono">${s.student_number || '-'}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${s.parent ? (s.parent.full_name || 'Ada') : '-'}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${getStatusColor(s.status)}">
                            ${s.status || 'Active'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            if (status === 'inactive') return 'bg-slate-100 text-slate-500';
            if (status === 'dropped') return 'bg-red-50 text-red-600';
            if (status === 'graduated') return 'bg-blue-50 text-blue-600';
            return 'bg-emerald-50 text-emerald-600';
        }

        function debounceSearchStudent() {
            clearTimeout(studentSearchDebounce);
            studentSearchDebounce = setTimeout(() => { studentPage = 1; loadStudents(1); }, 500);
        }

        function changeStudentPage(delta) {
            const newPage = studentPage + delta;
            if (newPage > 0) loadStudents(newPage);
        }

        function updatePagination(totalPages, current) {
            document.getElementById('btn-prev-student').disabled = current <= 1;
            document.getElementById('btn-next-student').disabled = current >= totalPages;
        }

        // --- RENDER FUNCTIONS ---
        function renderInstructors() {
            const grid = document.getElementById('instructors-grid');
            if (store.instructors.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center p-8 text-slate-400">Belum ada instruktur.</div>';
                return;
            }
            grid.innerHTML = store.instructors.map(i => `
                <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm hover:shadow-md transition-all group relative cursor-pointer" onclick="showInstructorDetail(${i.id})">
                    <button onclick="event.stopPropagation(); openEditInstructorModal(${i.id})" class="absolute top-4 right-4 text-slate-400 hover:text-blue-600 z-10 p-1 rounded hover:bg-slate-100"><i class="bi bi-pencil-square"></i></button>
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-full bg-slate-800 text-white flex items-center justify-center text-lg font-bold">${(i.full_name || i.name || 'I').charAt(0)}</div>
                        <div><h4 class="font-bold text-slate-800">${i.full_name || i.name}</h4><p class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded inline-block">${i.instructor_code || 'N/A'}</p></div>
                    </div>
                    <p class="text-sm text-slate-600"><i class="bi bi-mortarboard me-2"></i> ${i.specialization || '-'}</p>
                    <p class="text-sm text-slate-600"><i class="bi bi-envelope me-2"></i> ${i.email}</p>
                </div>
            `).join('');
        }

        function renderCourses() {
            const grid = document.getElementById('courses-grid');
            if (store.courses.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center p-8 text-slate-400">Belum ada kursus.</div>';
                return;
            }
            grid.innerHTML = store.courses.map(c => `
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition-all">
                    <div class="h-20 bg-gradient-to-r from-blue-600 to-indigo-600 p-4 flex items-end"><h4 class="text-white font-bold">${c.course_name || c.name}</h4></div>
                    <div class="p-5">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded">${c.course_code || 'CODE'}</span>
                            <span class="text-xs text-green-600 font-bold">Active</span>
                        </div>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">${c.description || 'No Desc'}</p>
                        <div class="flex gap-2 pt-2 border-t border-slate-100">
                             <button onclick="openEditCourseModal(${c.id})" class="flex-1 py-1.5 text-slate-500 hover:text-accent text-xs font-bold">Edit</button>
                             <button onclick="deleteCourse(${c.id})" class="flex-1 py-1.5 text-red-400 hover:text-red-600 text-xs font-bold">Hapus</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        function renderAnnouncements() {
            const list = document.getElementById('announcements-list');
            if (store.announcements.length === 0) {
                list.innerHTML = '<div class="text-center p-8 text-slate-400">Belum ada pengumuman.</div>';
                return;
            }
            list.innerHTML = store.announcements.map(a => `
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-slate-800">${a.title}</h4>
                        <p class="text-sm text-slate-500 line-clamp-1">${a.content}</p>
                        <span class="text-[10px] text-slate-400 uppercase mt-1 block">${new Date(a.created_at).toLocaleDateString()}</span>
                    </div>
                    <button onclick="deleteAnnouncement(${a.id})" class="text-slate-300 hover:text-red-500"><i class="bi bi-trash-fill"></i></button>
                </div>
            `).join('');
        }

        // --- ACTIONS & MODALS ---
        async function loadInstructorsForSelect(selectId) {
            const res = await fetchApi('/instructors');
            const data = (res && res.data) ? res.data : (Array.isArray(res) ? res : []);
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">Pilih Instruktur...</option>';
            data.forEach(i => {
                sel.innerHTML += `<option value="${i.id}">${i.full_name || i.name}</option>`;
            });
        }

        async function submitCreateCourse() {
            const payload = {
                course_name: document.getElementById('create-course-name').value,
                course_code: document.getElementById('create-course-code').value,
                description: document.getElementById('create-course-desc').value,
                instructor_id: document.getElementById('create-course-instructor').value
            };
            closeModal('modal-create-course');
            const res = await fetchApi('/courses', { method: 'POST', body: JSON.stringify(payload) });
            if (res) { Swal.fire('Berhasil', 'Kursus dibuat', 'success'); loadDashboardData(); }
        }

        async function openEditCourseModal(id) {
            const course = store.courses.find(c => c.id == id);
            if (!course) return;
            document.getElementById('edit-course-id').value = id;
            document.getElementById('edit-course-name').value = course.course_name || course.name;
            document.getElementById('edit-course-code').value = course.course_code || course.code;
            document.getElementById('edit-course-desc').value = course.description || '';
            document.getElementById('edit-course-status').value = course.status || 'Published';
            await loadInstructorsForSelect('edit-course-instructor');
            const sel = document.getElementById('edit-course-instructor');
            const insId = course.instructor_id || (course.instructor && course.instructor.id);
            if (insId) sel.value = insId;
            openModal('modal-edit-course');
        }

        async function updateCourse() {
            const id = document.getElementById('edit-course-id').value;
            const payload = {
                course_name: document.getElementById('edit-course-name').value,
                course_code: document.getElementById('edit-course-code').value,
                description: document.getElementById('edit-course-desc').value,
                instructor_id: document.getElementById('edit-course-instructor').value,
                status: document.getElementById('edit-course-status').value
            };
            closeModal('modal-edit-course');
            const res = await fetchApi(`/courses/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
            if (res) { Swal.fire('Update Berhasil', '', 'success'); loadDashboardData(); }
        }

        async function showInstructorDetail(id) {
            const resIns = await fetchApi(`/instructors/${id}`);
            if (!resIns) { Swal.fire('Error', 'Instruktur tidak ditemukan', 'error'); return; }

            const resCourses = await fetchApi(`/instructors/${id}/courses`);
            const myCourses = (resCourses && resCourses.data) ? resCourses.data : (Array.isArray(resCourses) ? resCourses : []);
            
            const insName = resIns.full_name || resIns.name;
            document.getElementById('det-ins-name').innerText = insName;
            document.getElementById('det-ins-code').innerText = resIns.instructor_code || 'N/A';
            document.getElementById('det-ins-email').innerText = resIns.email;
            document.getElementById('det-ins-spec').innerText = resIns.specialization;
            document.getElementById('det-ins-phone').innerText = resIns.phone || '-';
            document.getElementById('det-ins-avatar').innerText = insName.charAt(0);
            document.getElementById('det-ins-exp').innerText = (resIns.experience_years || 0) + ' Thn';
            document.getElementById('det-ins-bio').innerText = resIns.bio || 'Tidak ada biografi.';
            document.getElementById('det-ins-edu').innerText = resIns.education_level || '-';
            
            // Calc stats
            const totalStudents = myCourses.reduce((acc, curr) => acc + (curr.max_students || 0), 0);
            document.getElementById('det-ins-students').innerText = totalStudents;
            document.getElementById('det-ins-courses').innerText = myCourses.length;
            
            document.getElementById('det-ins-course-list').innerHTML = myCourses.length ? myCourses.map(c => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="px-6 py-3 font-bold text-slate-700">${c.course_name || c.name}</td>
                    <td class="px-6 py-3 text-xs font-mono">${c.course_code || c.code}</td>
                    <td class="px-6 py-3 text-center">${c.students_count || 0}</td>
                    <td class="px-6 py-3 text-center"><span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">${c.status || 'Active'}</span></td>
                </tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center text-slate-400">Belum ada kursus.</td></tr>';
            
            const btnEdit = document.getElementById('btn-edit-instructor-detail');
            if(btnEdit) btnEdit.onclick = () => openEditInstructorModal(id);

            nav('instructor-detail');
        }

        // --- UTILS ---
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.removeItem('auth_token'); location.reload(); }
        
        // Open Modal Wrappers
        async function openCreateCourseModal() {
            document.getElementById('create-course-name').value = '';
            document.getElementById('create-course-code').value = '';
            document.getElementById('create-course-desc').value = '';
            await loadInstructorsForSelect('create-course-instructor');
            openModal('modal-create-course');
        }
        
        async function submitInstructor() {
            const payload = {
                full_name: document.getElementById('ins-name').value,
                email: document.getElementById('ins-email').value,
                password: document.getElementById('ins-pass').value,
                instructor_code: document.getElementById('ins-code').value,
                phone: document.getElementById('ins-phone').value,
                specialization: document.getElementById('ins-spec').value,
                education_level: document.getElementById('ins-edu').value,
                experience_years: document.getElementById('ins-exp').value,
                bio: document.getElementById('ins-bio').value
            };
            closeModal('modal-instructor');
            const res = await fetchApi('/instructors', { method: 'POST', body: JSON.stringify(payload) });
            if (res) { Swal.fire('Berhasil', 'Instruktur ditambahkan', 'success'); loadDashboardData(); }
        }

        async function openEditInstructorModal(id) {
            const res = await fetchApi(`/instructors/${id}`);
            if (!res) return;
            document.getElementById('edit-ins-id').value = id;
            document.getElementById('edit-ins-name').value = res.full_name || res.name;
            document.getElementById('edit-ins-email').value = res.email;
            document.getElementById('edit-ins-code').value = res.instructor_code || '';
            document.getElementById('edit-ins-phone').value = res.phone || '';
            document.getElementById('edit-ins-spec').value = res.specialization || '';
            document.getElementById('edit-ins-edu').value = res.education_level || 'S1';
            document.getElementById('edit-ins-exp').value = res.experience_years || 0;
            document.getElementById('edit-ins-bio').value = res.bio || '';
            document.getElementById('edit-ins-status').value = res.status || 'active';
            openModal('modal-edit-instructor');
        }

        async function updateInstructor() {
            const id = document.getElementById('edit-ins-id').value;
            const payload = {
                full_name: document.getElementById('edit-ins-name').value,
                email: document.getElementById('edit-ins-email').value,
                phone: document.getElementById('edit-ins-phone').value,
                specialization: document.getElementById('edit-ins-spec').value,
                education_level: document.getElementById('edit-ins-edu').value,
                experience_years: document.getElementById('edit-ins-exp').value,
                bio: document.getElementById('edit-ins-bio').value,
                status: document.getElementById('edit-ins-status').value
            };
            closeModal('modal-edit-instructor');
            const res = await fetchApi(`/instructors/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
            if (res) { 
                Swal.fire('Update Berhasil', '', 'success'); 
                loadDashboardData();
                if(!document.getElementById('view-instructor-detail').classList.contains('hidden')) showInstructorDetail(id);
            }
        }

        async function deleteCourse(id) {
            if (await Swal.fire({ title: 'Hapus?', text: 'Data tidak bisa kembali', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' }).then(r => r.isConfirmed)) {
                const res = await fetchApi(`/courses/${id}`, { method: 'DELETE' });
                if (res) { 
                    Swal.fire('Terhapus', '', 'success'); 
                    nav('announcements');
                }
            }
        }

        async function deleteAnnouncement(id) {
            if (await Swal.fire({ title: 'Hapus Pengumuman?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' }).then(r => r.isConfirmed)) {
                const res = await fetchApi(`/announcements/${id}`, { method: 'DELETE' });
                if (res) { 
                    Swal.fire('Terhapus', '', 'success'); 
                    nav('announcements'); 
                }
            }
        }

        async function submitAnnouncement() {
            const payload = {
                title: document.getElementById('annTitle').value,
                content: document.getElementById('annContent').value,
                course_id: document.getElementById('annCourseId').value || null,
                announcement_type: "global",
                priority: document.getElementById('annPriority').value,
                status: document.getElementById('annStatus').value,
                published_at: document.getElementById('annPublishedAt').value,
                expires_at: ""
            };
            closeModal('modal-announcement');
            const res = await fetchApi('/announcements', { method: 'POST', body: JSON.stringify(payload) });
            if(res) { 
                Swal.fire('Berhasil', 'Pengumuman dibuat', 'success'); 
                closeModal('modal-announcement');
                setTimeout(() => nav('announcements'), 100);
            }
        }
    </script>
</body>
</html>